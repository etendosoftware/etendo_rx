---
phase: 01-dynamic-metadata-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules_core/com.etendorx.das/build.gradle
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMappingType.java
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/ProjectionMetadata.java
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/EntityMetadata.java
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMetadata.java
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/DynamicMetadataService.java
autonomous: true

must_haves:
  truths:
    - "All four field mapping types (DM, JM, CV, JP) are correctly represented in the metadata model"
    - "Metadata models are immutable Java records suitable for caching"
    - "Service interface defines the full public API for metadata queries"
  artifacts:
    - path: "modules_core/com.etendorx.das/build.gradle"
      provides: "Caffeine and spring-boot-starter-cache dependencies"
      contains: "caffeine"
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMappingType.java"
      provides: "Type-safe enum for field mapping types"
      contains: "DIRECT_MAPPING"
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/ProjectionMetadata.java"
      provides: "Immutable projection metadata record"
      contains: "record ProjectionMetadata"
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/EntityMetadata.java"
      provides: "Immutable entity metadata record"
      contains: "record EntityMetadata"
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMetadata.java"
      provides: "Immutable field metadata record"
      contains: "record FieldMetadata"
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/DynamicMetadataService.java"
      provides: "Public API interface for metadata queries"
      exports: ["getProjection", "getProjectionEntity", "getFields", "invalidateCache"]
  key_links:
    - from: "FieldMetadata.java"
      to: "FieldMappingType.java"
      via: "record field referencing enum type"
      pattern: "FieldMappingType fieldMapping"
    - from: "ProjectionMetadata.java"
      to: "EntityMetadata.java"
      via: "record field List<EntityMetadata>"
      pattern: "List<EntityMetadata> entities"
    - from: "DynamicMetadataService.java"
      to: "ProjectionMetadata/EntityMetadata/FieldMetadata"
      via: "return types in interface methods"
      pattern: "Optional<ProjectionMetadata>|Optional<EntityMetadata>|List<FieldMetadata>"
---

<objective>
Create the metadata models, FieldMappingType enum, Caffeine/cache dependencies, and the DynamicMetadataService interface.

Purpose: These are the foundational types and API contract that the service implementation (Plan 02) and all downstream phases depend on. Separating models from implementation keeps this plan focused and avoids context exhaustion.

Output: 5 Java source files (4 models + 1 interface) and updated build.gradle with cache dependencies.
</objective>

<execution_context>
@/Users/sebastianbarrozo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianbarrozo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dynamic-metadata-service/01-RESEARCH.md

Key existing files to reference:
@modules_core/com.etendorx.das/build.gradle
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/EtendorxDasApplication.java
@modules_gen/com.etendorx.entities/src/main/entities/com/etendoerp/etendorx/data/ETRXProjection.java
@modules_gen/com.etendorx.entities/src/main/entities/com/etendoerp/etendorx/data/ETRXProjectionEntity.java
@modules_gen/com.etendorx.entities/src/main/entities/com/etendoerp/etendorx/data/ETRXEntityField.java
@modules_gen/com.etendorx.entities/src/main/entities/com/etendoerp/etendorx/data/ETRXJavaMapping.java
@modules_gen/com.etendorx.entities/src/main/entities/com/etendoerp/etendorx/data/ConstantValue.java
@modules_gen/com.etendorx.entities/src/main/jparepo/com/etendorx/entities/jparepo/ETRX_ProjectionRepository.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create metadata models</name>
  <files>
    modules_core/com.etendorx.das/build.gradle
    modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMappingType.java
    modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/ProjectionMetadata.java
    modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/EntityMetadata.java
    modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMetadata.java
  </files>
  <action>
    1. **Modify `build.gradle`** - Add two dependencies to the `dependencies` block:
       ```
       implementation 'org.springframework.boot:spring-boot-starter-cache'
       implementation 'com.github.ben-manes.caffeine:caffeine:3.1.8'
       ```
       Add them near the existing `spring-boot-starter-*` dependencies. Do NOT change anything else in build.gradle.

    2. **Create `FieldMappingType.java`** - Enum with four values:
       - `DIRECT_MAPPING("DM")` - Direct property-to-field mapping
       - `JAVA_MAPPING("JM")` - Custom Java converter via qualifier
       - `CONSTANT_VALUE("CV")` - Static constant value
       - `JSON_PATH("JP")` - JsonPath extraction
       Include a `code` field (the 2-char DB value), a constructor, a static `fromCode(String)` method that returns the enum for a DB code (throw IllegalArgumentException for unknown codes), and a `getCode()` getter. Package: `com.etendorx.das.metadata.models`.

    3. **Create `FieldMetadata.java`** - Java record in `com.etendorx.das.metadata.models`:
       ```java
       public record FieldMetadata(
           String id,
           String name,
           String property,
           FieldMappingType fieldMapping,
           boolean mandatory,
           boolean identifiesUnivocally,
           Long line,
           // JM-specific: qualifier of the Java mapping bean
           String javaMappingQualifier,
           // CV-specific: the constant value string
           String constantValue,
           // JP-specific: the jsonpath expression
           String jsonPath,
           // Related entity projection entity ID (for entity references)
           String relatedProjectionEntityId,
           boolean createRelated
       ) {}
       ```
       This record captures ALL field-level metadata needed by downstream converter. The nullable fields (javaMappingQualifier, constantValue, jsonPath, relatedProjectionEntityId) are populated based on fieldMapping type.

    4. **Create `EntityMetadata.java`** - Java record in `com.etendorx.das.metadata.models`:
       ```java
       public record EntityMetadata(
           String id,
           String name,
           String tableId,
           String mappingType,
           boolean identity,
           boolean restEndPoint,
           String externalName,
           List<FieldMetadata> fields
       ) {}
       ```
       Use `java.util.List`. Include `mappingType`, `restEndPoint`, and `externalName` from ETRXProjectionEntity - these are needed by Phase 4 (controller endpoint registration).

    5. **Create `ProjectionMetadata.java`** - Java record in `com.etendorx.das.metadata.models`:
       ```java
       public record ProjectionMetadata(
           String id,
           String name,
           String description,
           boolean grpc,
           List<EntityMetadata> entities
       ) {
           /**
            * Find an entity within this projection by name.
            * @return Optional containing the entity metadata, or empty if not found
            */
           public Optional<EntityMetadata> findEntity(String entityName) {
               return entities.stream()
                   .filter(e -> e.name().equals(entityName))
                   .findFirst();
           }
       }
       ```
       Include `description` from ETRXProjection. Add `findEntity(String entityName)` convenience method that filters the entities list - this supports the `getProjectionEntity(projectionName, entityName)` API without extra DB calls.
  </action>
  <verify>
    All 5 files exist at the specified paths. Run: `find modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata -name "*.java" | sort` and confirm all 5 files are listed. Verify `build.gradle` contains `caffeine` dependency.
  </verify>
  <done>
    - build.gradle has spring-boot-starter-cache and caffeine dependencies
    - FieldMappingType enum has 4 values with fromCode() parsing
    - FieldMetadata record captures all field properties including mapping-type-specific nullable fields
    - EntityMetadata record captures all entity properties including restEndPoint and externalName
    - ProjectionMetadata record has findEntity() convenience method
    - All records use immutable fields (Java record pattern)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DynamicMetadataService interface</name>
  <files>
    modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/DynamicMetadataService.java
  </files>
  <action>
    Create `DynamicMetadataService.java` interface in `com.etendorx.das.metadata`:
    ```java
    public interface DynamicMetadataService {
        /**
         * Get projection metadata by name.
         * @param name the projection name (e.g., "Product", "BusinessPartner")
         * @return the projection metadata, or empty if not found
         */
        Optional<ProjectionMetadata> getProjection(String name);

        /**
         * Get a specific entity within a projection.
         * @param projectionName the projection name
         * @param entityName the entity name within the projection
         * @return the entity metadata, or empty if projection or entity not found
         */
        Optional<EntityMetadata> getProjectionEntity(String projectionName, String entityName);

        /**
         * Get all fields for a projection entity by its ID.
         * @param projectionEntityId the projection entity UUID
         * @return list of field metadata, empty list if entity not found
         */
        List<FieldMetadata> getFields(String projectionEntityId);

        /**
         * Get all loaded projection names.
         * @return set of projection names currently in cache
         */
        Set<String> getAllProjectionNames();

        /**
         * Invalidate all cached metadata, forcing reload on next access.
         */
        void invalidateCache();
    }
    ```
    Import the model types from `com.etendorx.das.metadata.models`. Use `java.util.Optional`, `java.util.List`, `java.util.Set`.
  </action>
  <verify>
    File exists at `modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/DynamicMetadataService.java`. Contains 5 method signatures: `getProjection`, `getProjectionEntity`, `getFields`, `getAllProjectionNames`, `invalidateCache`.
  </verify>
  <done>
    - DynamicMetadataService interface exposes all 5 API methods
    - Return types use immutable model records from Task 1
    - Javadoc documents each method's contract
  </done>
</task>

</tasks>

<verification>
1. All 6 new/modified files exist at the correct paths under `modules_core/com.etendorx.das/`
2. Package structure: `com.etendorx.das.metadata`, `com.etendorx.das.metadata.models`
3. `build.gradle` has `spring-boot-starter-cache` and `caffeine` dependencies
4. `FieldMappingType.fromCode("DM")` returns `DIRECT_MAPPING` (and so on for JM, CV, JP)
5. No generated files in `modules_gen/` were modified
</verification>

<success_criteria>
- build.gradle updated with cache dependencies
- 4 immutable Java record model classes created
- FieldMappingType enum with 4 values and fromCode() method
- DynamicMetadataService interface with 5 methods
- All files compile (verified by downstream Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-dynamic-metadata-service/01-01-SUMMARY.md`
</output>
