---
phase: 02-generic-dto-converter
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DynamicDTOConverterTest.java
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DirectMappingStrategyTest.java
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/EntityMappingStrategyTest.java
autonomous: true

must_haves:
  truths:
    - "Tests verify DM strategy reads properties via PropertyAccessor and applies handleBaseObject"
    - "Tests verify DM strategy writes values with Date type coercion"
    - "Tests verify EM strategy detects cycles and returns stub for already-visited entities"
    - "Tests verify EM strategy recursively converts related entities"
    - "Tests verify converter orchestrator delegates to correct strategy per FieldMappingType"
    - "Tests verify mandatory field validation throws ConversionException"
    - "Tests verify audit fields set on convertToEntity for BaseRXObject"
    - "Tests verify null handling: null properties return null, null related entities return null"
  artifacts:
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DynamicDTOConverterTest.java"
      provides: "Orchestrator tests: convertToMap, convertToEntity, mandatory validation, audit"
      contains: "class DynamicDTOConverterTest"
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DirectMappingStrategyTest.java"
      provides: "DM strategy tests: read, write, null handling, type coercion"
      contains: "class DirectMappingStrategyTest"
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/EntityMappingStrategyTest.java"
      provides: "EM strategy tests: recursion, cycle detection, ExternalId write"
      contains: "class EntityMappingStrategyTest"
  key_links:
    - from: "DynamicDTOConverterTest"
      to: "DynamicDTOConverter"
      via: "Mockito mocks for strategies and metadata service"
      pattern: "@Mock.*FieldConversionStrategy"
    - from: "DirectMappingStrategyTest"
      to: "DirectMappingStrategy"
      via: "Mockito mocks for PropertyAccessorService and MappingUtils"
      pattern: "@Mock.*PropertyAccessorService"
---

<objective>
Create comprehensive unit tests for the dynamic DTO converter: strategy-level tests for DM and EM (the most complex strategies), and orchestrator-level tests for DynamicDTOConverter.

Purpose: Verify the converter produces correct output for all field mapping types, handles edge cases (nulls, cycles, missing fields, type coercion), and integrates properly with audit fields and mandatory validation.

Output: 3 test files covering the critical conversion paths.
</objective>

<execution_context>
@/Users/sebastianbarrozo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianbarrozo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-generic-dto-converter/02-CONTEXT.md
@.planning/phases/02-generic-dto-converter/02-RESEARCH.md
@.planning/phases/02-generic-dto-converter/02-01-SUMMARY.md
@.planning/phases/02-generic-dto-converter/02-02-SUMMARY.md

Test style reference:
@modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/DynamicMetadataServiceTest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DirectMappingStrategy and EntityMappingStrategy unit tests</name>
  <files>
    modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DirectMappingStrategyTest.java
    modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/EntityMappingStrategyTest.java
  </files>
  <action>
    Follow the project's established test style: `@ExtendWith(MockitoExtension.class)`, AAA pattern (Arrange-Act-Assert), descriptive test method names.

    1. **Create `DirectMappingStrategyTest.java`** in `com.etendorx.das.unit.converter` package:
       - `@ExtendWith(MockitoExtension.class)` and `@MockitoSettings(strictness = Strictness.LENIENT)`.
       - `@Mock PropertyAccessorService propertyAccessorService`
       - `@Mock MappingUtils mappingUtils`
       - `@InjectMocks DirectMappingStrategy strategy`
       - Helper method to create `FieldMetadata` test records with specific property names.
       - **Test cases:**
         - `readField_simpleProperty_returnsHandledValue`: Mock getNestedProperty to return "rawValue", mock handleBaseObject to return "processedValue". Assert readField returns "processedValue".
         - `readField_nullProperty_returnsNull`: Mock getNestedProperty to return null. Assert readField returns null. Verify handleBaseObject NOT called.
         - `readField_nestedProperty_readsCorrectPath`: Create field with property "defaultrole.id". Verify getNestedProperty called with "defaultrole.id".
         - `readField_dateProperty_formatsViaHandleBaseObject`: Mock getNestedProperty to return a Date. Mock handleBaseObject to return formatted string. Assert readField returns the formatted string.
         - `writeField_simpleValue_setsProperty`: Call writeField with String value. Verify setNestedProperty called with correct args.
         - `writeField_nullValue_setsNull`: Call writeField with null value. Verify setNestedProperty called with null.
         - `writeField_dateCoercion_parsesString`: Test that when writing a Date-type property with a String value, the strategy performs date coercion. This depends on the implementation details -- mock as needed.

    2. **Create `EntityMappingStrategyTest.java`** in `com.etendorx.das.unit.converter` package:
       - `@ExtendWith(MockitoExtension.class)` and `@MockitoSettings(strictness = Strictness.LENIENT)`.
       - `@Mock PropertyAccessorService propertyAccessorService`
       - `@Mock DynamicMetadataService metadataService`
       - `@Mock ExternalIdService externalIdService`
       - `@Mock EntityManager entityManager`
       - `@Mock DynamicDTOConverter dynamicDTOConverter`
       - Construct `EntityMappingStrategy` manually in `@BeforeEach` passing all mocks (since @Lazy prevents simple InjectMocks).
       - Helper: Create a simple test POJO class (inner class) with id, identifier, and a related entity field to simulate JPA entity structure. Or use `BaseRXObject` mock.
       - **Test cases:**
         - `readField_relatedEntityNull_returnsNull`: Mock property accessor to return null. Assert readField returns null.
         - `readField_cycleDetected_returnsStub`: Create ConversionContext, pre-visit an entity. Call readField for same entity. Assert returned Map contains only "id" and "_identifier".
         - `readField_normalEntity_recursivelyConverts`: Mock property accessor to return a related entity. Mock metadataService to return related EntityMetadata. Mock dynamicDTOConverter.convertToMap to return a test Map. Assert readField returns the Map from recursive call.
         - `writeField_mapWithId_resolvesViaExternalId`: Create Map with "id" key. Mock externalIdService.convertExternalToInternalId to return internal ID. Mock entityManager query to return entity. Verify propertyAccessorService.setNestedProperty called with resolved entity.
         - `writeField_nullValue_setsNull`: Assert writeField with null value calls setNestedProperty with null.
         - `writeField_stringId_resolvesDirectly`: Pass a String value (ID). Verify ExternalIdService called with that string.
  </action>
  <verify>
    - Both test files exist in `com.etendorx.das.unit.converter` package.
    - `DirectMappingStrategyTest` has at least 6 test methods.
    - `EntityMappingStrategyTest` has at least 5 test methods.
    - Tests use `@ExtendWith(MockitoExtension.class)` and AAA pattern.
    - Cycle detection test creates ConversionContext, marks entity as visited, then verifies stub returned.
    - ExternalId resolution test verifies `externalIdService.convertExternalToInternalId()` called.
  </verify>
  <done>Strategy-level tests cover DM read/write (null handling, type coercion, nested paths) and EM read/write (cycle detection, recursive conversion, ExternalId resolution).</done>
</task>

<task type="auto">
  <name>Task 2: Create DynamicDTOConverter orchestrator unit tests</name>
  <files>
    modules_core/com.etendorx.das/src/test/java/com/etendorx/das/unit/converter/DynamicDTOConverterTest.java
  </files>
  <action>
    **Create `DynamicDTOConverterTest.java`** in `com.etendorx.das.unit.converter` package:

    - `@ExtendWith(MockitoExtension.class)` and `@MockitoSettings(strictness = Strictness.LENIENT)`.
    - Mock all 6 strategies and metadata service:
      - `@Mock DirectMappingStrategy directMappingStrategy`
      - `@Mock ConstantValueStrategy constantValueStrategy`
      - `@Mock ComputedMappingStrategy computedMappingStrategy`
      - `@Mock EntityMappingStrategy entityMappingStrategy`
      - `@Mock JavaMappingStrategy javaMappingStrategy`
      - `@Mock JsonPathStrategy jsonPathStrategy`
      - `@Mock DynamicMetadataService metadataService`
      - `@Mock AuditServiceInterceptor auditServiceInterceptor`
      - `@Mock EntityManager entityManager`
    - Construct `DynamicDTOConverter` manually in `@BeforeEach`, passing all mocks.
    - Helper methods:
      - `createFieldMetadata(String name, String property, FieldMappingType type)` -- returns a FieldMetadata record with given values and sensible defaults.
      - `createEntityMetadata(String id, String name, List<FieldMetadata> fields)` -- returns an EntityMetadata record.

    **convertToMap tests:**
    - `convertToMap_nullEntity_returnsNull`: Assert converter returns null for null entity.
    - `convertToMap_emptyFields_returnsEmptyMap`: Pass entity with empty fields list. Assert empty Map returned.
    - `convertToMap_singleDMField_delegatesToDirectMapping`: Create one DM field. Mock DirectMappingStrategy.readField to return "test". Assert result map has field with "test".
    - `convertToMap_multipleFieldTypes_delegatesToCorrectStrategies`: Create fields of different types (DM, CV, JM). Mock each strategy. Verify each strategy's readField called once. Assert result map has all fields.
    - `convertToMap_strategyThrows_putsNullForField`: Mock a strategy to throw RuntimeException. Assert result map has null for that field (graceful degradation).
    - `convertToMap_preservesFieldOrder`: Create 3 DM fields with different names. Assert result Map (LinkedHashMap) iteration order matches field order.

    **convertToEntity tests:**
    - `convertToEntity_nullDto_throwsConversionException`: Assert ConversionException thrown for null DTO.
    - `convertToEntity_singleDMField_delegatesToDirectMapping`: Create Map with one field. Provide a pre-created entity object (a mock or simple POJO). Verify DirectMappingStrategy.writeField called with correct arguments.
    - `convertToEntity_mandatoryFieldMissing_throwsConversionException`: Create mandatory DM field. Pass DTO Map without that field key. Assert ConversionException thrown with message containing the field name.
    - `convertToEntity_mandatoryFieldPresent_noException`: Create mandatory DM field. Pass DTO Map WITH that field. Assert no exception and strategy.writeField called.
    - `convertToEntity_cvFieldMandatory_notValidated`: Create mandatory CV field. Pass DTO Map without that field. Assert NO exception (CV fields come from DB, not from DTO).
    - `convertToEntity_auditFieldsSet_forBaseRXObject`: Create a mock `BaseRXObject` entity. Call convertToEntity. Verify `auditServiceInterceptor.setAuditValues(entity)` called.
    - `convertToEntity_auditFieldsNotSet_forNonBaseRXObject`: Pass a plain Object as entity. Verify `auditServiceInterceptor.setAuditValues()` NOT called.
    - `convertToEntity_setsFullDtoOnContext`: Verify that when writeField is called, the ConversionContext passed to it has fullDto set to the input DTO. Use ArgumentCaptor on the strategy's writeField to capture the ConversionContext argument.

    **Total: ~14 test cases across the orchestrator.**
  </action>
  <verify>
    - `DynamicDTOConverterTest.java` exists in `com.etendorx.das.unit.converter` package.
    - At least 12 test methods across convertToMap and convertToEntity.
    - Tests verify strategy delegation: each FieldMappingType routes to correct strategy.
    - Tests verify mandatory field validation with clear error messages.
    - Tests verify audit field integration for BaseRXObject instances.
    - Tests verify graceful degradation when strategy throws.
    - Tests use Mockito mocks, not real implementations (unit tests, not integration).
    - Test style matches project convention: @ExtendWith(MockitoExtension.class), AAA pattern.
  </verify>
  <done>Orchestrator tests comprehensively cover: strategy routing, convertToMap, convertToEntity, mandatory validation, audit integration, null handling, error graceful degradation, and ConversionContext fullDto propagation.</done>
</task>

</tasks>

<verification>
- All 3 test files exist in `com.etendorx.das.unit.converter` package.
- Total of ~20+ test methods across all files.
- Test coverage includes: read path (DM, EM), write path (DM, EM), orchestrator routing, mandatory validation, audit fields, cycle detection, ExternalId resolution, null handling, error handling.
- Tests follow project conventions: @ExtendWith, AAA, descriptive names.
- All tests use mocks (unit tests, not integration tests requiring DB).
- Tests do NOT depend on project compilation of generated entities (uses mocks).
</verification>

<success_criteria>
- Tests written and syntactically correct.
- DM strategy tested: read with handleBaseObject, write with type coercion, null handling.
- EM strategy tested: cycle detection stub, recursive conversion, ExternalId write resolution.
- Orchestrator tested: strategy routing, mandatory validation, audit integration, null entity, error handling.
- Test file count matches plan: 3 files.
- Note: Tests may not execute due to pre-existing compilation blocker (same as Phase 1 tests). Tests are written correctly and will pass when blocker is resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/02-generic-dto-converter/02-03-SUMMARY.md`
</output>
