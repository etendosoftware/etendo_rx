---
phase: 04-generic-rest-controller
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/ExternalIdTranslationService.java
  - modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/DynamicEndpointRegistry.java
autonomous: true

must_haves:
  truths:
    - "External IDs in incoming DTO maps are translated to internal IDs before repository save"
    - "The id field in incoming DTOs is translated via convertExternalToInternalId"
    - "ENTITY_MAPPING fields with identifiesUnivocally=true have their IDs translated"
    - "All registered dynamic endpoints are logged at startup with their URL pattern"
    - "Entities with restEndPoint=false are excluded from startup logging"
  artifacts:
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/ExternalIdTranslationService.java"
      provides: "External ID translation orchestration for incoming DTOs"
      exports: ["translateExternalIds"]
    - path: "modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/DynamicEndpointRegistry.java"
      provides: "Startup logging and entity REST endpoint validation"
      exports: ["logDynamicEndpoints", "isRestEndpoint"]
  key_links:
    - from: "ExternalIdTranslationService"
      to: "ExternalIdService.convertExternalToInternalId"
      via: "Delegation per ENTITY_MAPPING field"
      pattern: "externalIdService\\.convertExternalToInternalId"
    - from: "ExternalIdTranslationService"
      to: "DynamicMetadataService"
      via: "Field metadata and related entity metadata lookup"
      pattern: "metadataService\\.getFields\\|metadataService\\.getProjectionEntity"
    - from: "DynamicEndpointRegistry"
      to: "DynamicMetadataService.getAllProjectionNames"
      via: "@EventListener(ApplicationReadyEvent) startup scan"
      pattern: "metadataService\\.getAllProjectionNames"
---

<objective>
Create two supporting services for the dynamic REST controller: ExternalIdTranslationService (translates external system IDs to internal IDs in incoming DTOs) and DynamicEndpointRegistry (logs dynamic endpoints at startup and validates restEndPoint flag).

Purpose: These services isolate controller concerns -- ExternalIdTranslationService handles FR-5 (external ID integration at controller level, deferred from Phase 3), and DynamicEndpointRegistry handles NFR-4 (startup logging) plus the restEndPoint validation gate.

Output: Two @Component classes in com.etendorx.das.controller package ready for DynamicRestController to consume in Plan 02.
</objective>

<execution_context>
@/Users/sebastianbarrozo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianbarrozo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-generic-rest-controller/04-RESEARCH.md

Key prior work:
- DynamicMetadataService: getProjection(name), getProjectionEntity(projName, entityName), getFields(projEntityId), getAllProjectionNames()
- ExternalIdService: convertExternalToInternalId(tableId, value) -- returns internal ID or original value if not found
- EntityMetadata: id(), name(), tableId(), restEndPoint(), externalName(), fields()
- FieldMetadata: name(), fieldMapping(), identifiesUnivocally(), relatedProjectionEntityId()
- FieldMappingType: ENTITY_MAPPING (the type that references other entities)

Source files to reference:
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/DynamicMetadataService.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/EntityMetadata.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMetadata.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/FieldMappingType.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/metadata/models/ProjectionMetadata.java
@libs/com.etendorx.das_core/src/main/java/com/etendorx/entities/mapper/lib/ExternalIdService.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/converter/strategy/EntityMappingStrategy.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExternalIdTranslationService</name>
  <files>modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/ExternalIdTranslationService.java</files>
  <action>
Create `ExternalIdTranslationService` as a `@Component` in package `com.etendorx.das.controller`.

Constructor-inject:
- `ExternalIdService externalIdService`
- `DynamicMetadataService metadataService`

Public method `translateExternalIds(Map<String, Object> dto, EntityMetadata entityMeta)`:
1. **Translate the "id" field** if present in the DTO:
   - `String dtoId = (String) dto.get("id");`
   - If dtoId is not null/blank: `dto.put("id", externalIdService.convertExternalToInternalId(entityMeta.tableId(), dtoId));`
   - This handles upsert matching with external system IDs.

2. **Translate ENTITY_MAPPING reference fields**:
   - Iterate `entityMeta.fields()` looking for fields where `field.fieldMapping() == FieldMappingType.ENTITY_MAPPING`
   - For each such field, check if the DTO contains a value for `field.name()`
   - Extract the reference ID: the DTO value for an EM field can be a String ID or a Map (nested object) with an "id" key. Handle both:
     - If value is a `String`, that IS the reference ID
     - If value is a `Map<?,?>`, get `((Map<?,?>) value).get("id")` as the reference ID
     - Otherwise skip (log warn)
   - Resolve the related entity's tableId: call `metadataService.getFields(field.relatedProjectionEntityId())` is NOT needed since we need the related ENTITY metadata, not fields. Instead, use a helper approach: the EntityMappingStrategy already resolves related entity metadata via `DynamicDTOConverter.findEntityMetadataById(field.relatedProjectionEntityId())`. For ExternalIdTranslationService, iterate all projection entities to find the one matching `relatedProjectionEntityId`. However, a simpler approach: since `metadataService.getProjectionEntity` requires a projection+entity name pair and we only have the related projection entity ID, we need to scan. BUT looking at how EntityMappingStrategy does it (lines 108-114), it uses `converter.findEntityMetadataById()`. For the translation service, since we are at the controller level before the converter, we need our own lookup.
   - **Simplest approach**: The `relatedProjectionEntityId` is the ID of an `EntityMetadata` record. We need its `tableId`. Since `DynamicMetadataService` provides `getProjection(name)` and `getAllProjectionNames()`, we can scan. But this is inefficient for every request.
   - **Better approach**: Build a small cache at construction or as a lazy lookup. Create a private helper `findEntityMetadataById(String projectionEntityId)` that iterates all projections (via `getAllProjectionNames` + `getProjection`) and searches for an entity with matching `id()`. Cache results in a `ConcurrentHashMap<String, EntityMetadata>`.
   - Once you have the related `EntityMetadata`, call `externalIdService.convertExternalToInternalId(relatedEntityMeta.tableId(), referenceId)`
   - Replace the DTO value: if the original value was a String, put the translated String. If it was a Map, create a new HashMap from the original Map and update its "id" entry with the translated value, then put it back.

3. Return void (mutates the dto map in place) or return the modified map. Prefer mutating in place since the controller creates the map fresh from JSON parsing anyway.

Add `@Slf4j` for logging.

IMPORTANT: Do NOT call `convertExternalToInternalId` for fields that are NOT `ENTITY_MAPPING` type. Only "id" (top-level) and ENTITY_MAPPING fields need translation.

Reference the pattern from EntityMappingStrategy.writeField() (lines 100-128) which shows how related entity metadata is resolved and convertExternalToInternalId is called.
  </action>
  <verify>
File exists at the expected path. Class compiles conceptually: has @Component, @Slf4j, constructor injection of ExternalIdService and DynamicMetadataService, public translateExternalIds method, ConcurrentHashMap cache for entity metadata by ID lookup.
  </verify>
  <done>
ExternalIdTranslationService exists with translateExternalIds method that:
- Translates the "id" field using entityMeta.tableId()
- Iterates ENTITY_MAPPING fields and translates their reference IDs using the related entity's tableId
- Handles both String and Map DTO field values for reference IDs
- Uses ConcurrentHashMap to cache entity metadata by ID lookups
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DynamicEndpointRegistry</name>
  <files>modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/DynamicEndpointRegistry.java</files>
  <action>
Create `DynamicEndpointRegistry` as a `@Component` in package `com.etendorx.das.controller`.

Constructor-inject:
- `DynamicMetadataService metadataService`

**Method 1: `logDynamicEndpoints()`**
- Annotate with `@EventListener(ApplicationReadyEvent.class)` (same pattern as metadata preload from Phase 1)
- Iterate all projection names via `metadataService.getAllProjectionNames()`
- For each projection, get the full `ProjectionMetadata` via `metadataService.getProjection(name)`
- For each entity in the projection:
  - If `entity.restEndPoint()` is true:
    - Log at INFO level: `"Dynamic endpoint registered: /{}/{}"` with `projectionName.toLowerCase()` and `entity.externalName()`
    - If `entity.externalName()` is null, fall back to `entity.name()`
  - If `entity.restEndPoint()` is false:
    - Log at DEBUG level: `"Skipping REST endpoint for: {}/{} (restEndPoint=false)"` with projectionName and entity name
- After iterating all projections, log summary: `"Dynamic endpoints: {} endpoints registered across {} projections"` with total endpoint count and projection count

**Method 2: `isRestEndpoint(String projectionName, String entityExternalName)`**
- Returns boolean indicating whether the given projection+entity combination has `restEndPoint=true`
- Resolve projection via `metadataService.getProjection(projectionName.toUpperCase())`
- If projection not found, return false
- Find entity by externalName: iterate `projection.entities()` and find one where `entity.externalName()` equals `entityExternalName` (or falls back to `entity.name()` if externalName is null)
- If entity found, return `entity.restEndPoint()`
- If entity not found, return false
- This method is called by the controller before processing any request to gate non-REST entities

**Method 3: `resolveEntityByExternalName(String projectionName, String entityExternalName)`**
- Returns `Optional<EntityMetadata>` for the entity matching the given external name within the projection
- This is needed because `ProjectionMetadata.findEntity()` matches by `name`, but the URL uses `externalName`
- Resolve projection via `metadataService.getProjection(projectionName.toUpperCase())`
- If projection not found, return `Optional.empty()`
- Iterate `projection.entities()` and match: `entity.externalName() != null && entity.externalName().equals(entityExternalName)` OR (if externalName is null) `entity.name().equals(entityExternalName)`
- Return first match wrapped in Optional

Add `@Slf4j` for logging.
  </action>
  <verify>
File exists at expected path. Class has @Component, @Slf4j, constructor injection of DynamicMetadataService, three methods: logDynamicEndpoints() with @EventListener, isRestEndpoint(String, String), resolveEntityByExternalName(String, String).
  </verify>
  <done>
DynamicEndpointRegistry exists with:
- logDynamicEndpoints() logs all restEndPoint=true entities at startup with URL patterns
- isRestEndpoint() returns boolean for restEndPoint gate check
- resolveEntityByExternalName() resolves entity by externalName (not name) for URL routing
  </done>
</task>

</tasks>

<verification>
1. Both files exist in `modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/`
2. ExternalIdTranslationService imports and uses `ExternalIdService.convertExternalToInternalId`
3. DynamicEndpointRegistry imports and uses `DynamicMetadataService.getAllProjectionNames`
4. Both classes have `@Component` and `@Slf4j` annotations
5. No shared file conflicts with Plan 02 (Plan 02 creates DynamicRestController.java only)
</verification>

<success_criteria>
- ExternalIdTranslationService.translateExternalIds() translates "id" and ENTITY_MAPPING reference fields
- DynamicEndpointRegistry.logDynamicEndpoints() runs at startup and logs all REST endpoints
- DynamicEndpointRegistry.resolveEntityByExternalName() resolves entities by externalName for URL routing
- DynamicEndpointRegistry.isRestEndpoint() gates non-REST entities
</success_criteria>

<output>
After completion, create `.planning/phases/04-generic-rest-controller/04-01-SUMMARY.md`
</output>
