---
phase: 04-generic-rest-controller
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/ExternalIdTranslationServiceTest.java
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicEndpointRegistryTest.java
  - modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicRestControllerTest.java
autonomous: true

must_haves:
  truths:
    - "ExternalIdTranslationService translates id field correctly"
    - "ExternalIdTranslationService translates ENTITY_MAPPING reference fields (both String and Map values)"
    - "ExternalIdTranslationService skips non-ENTITY_MAPPING fields"
    - "DynamicEndpointRegistry logs endpoints at startup"
    - "DynamicEndpointRegistry resolves entities by externalName"
    - "DynamicEndpointRegistry returns false for restEndPoint=false entities"
    - "DynamicRestController GET list returns paginated results"
    - "DynamicRestController GET by ID returns entity or 404"
    - "DynamicRestController POST creates single entity with 201"
    - "DynamicRestController POST handles batch with JSONArray"
    - "DynamicRestController PUT updates entity with 201"
    - "DynamicRestController returns 404 for non-existent projection"
    - "DynamicRestController returns 404 for restEndPoint=false"
  artifacts:
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/ExternalIdTranslationServiceTest.java"
      provides: "Unit tests for external ID translation"
      min_lines: 80
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicEndpointRegistryTest.java"
      provides: "Unit tests for endpoint registry"
      min_lines: 60
    - path: "modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicRestControllerTest.java"
      provides: "Unit tests for REST controller"
      min_lines: 150
  key_links:
    - from: "ExternalIdTranslationServiceTest"
      to: "ExternalIdTranslationService.translateExternalIds"
      via: "Mock ExternalIdService and DynamicMetadataService, verify DTO mutation"
      pattern: "translateExternalIds|convertExternalToInternalId"
    - from: "DynamicRestControllerTest"
      to: "DynamicRestController CRUD methods"
      via: "Direct unit test with mocked DynamicRepository, DynamicEndpointRegistry, ExternalIdTranslationService"
      pattern: "findAll|findById|create|update"
---

<objective>
Create unit tests for all three Phase 4 components: ExternalIdTranslationService, DynamicEndpointRegistry, and DynamicRestController.

Purpose: Verify that external ID translation, endpoint registration, and REST controller logic work correctly in isolation. Tests follow the established project pattern (@ExtendWith(MockitoExtension.class), AAA pattern).

Output: Three test classes covering the critical behaviors of each component.
</objective>

<execution_context>
@/Users/sebastianbarrozo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianbarrozo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-generic-rest-controller/04-01-SUMMARY.md
@.planning/phases/04-generic-rest-controller/04-02-SUMMARY.md

Source files to test:
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/ExternalIdTranslationService.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/DynamicEndpointRegistry.java
@modules_core/com.etendorx.das/src/main/java/com/etendorx/das/controller/DynamicRestController.java

Test pattern references:
@modules_core/com.etendorx.das/src/test/java/com/etendorx/das/repository/DynamicRepositoryTest.java
@modules_core/com.etendorx.das/src/test/java/com/etendorx/das/repository/EntityClassResolverTest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExternalIdTranslationServiceTest and DynamicEndpointRegistryTest</name>
  <files>
    modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/ExternalIdTranslationServiceTest.java
    modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicEndpointRegistryTest.java
  </files>
  <action>
**ExternalIdTranslationServiceTest:**

Use `@ExtendWith(MockitoExtension.class)` with AAA pattern (Arrange/Act/Assert).

Mock dependencies:
- `@Mock ExternalIdService externalIdService`
- `@Mock DynamicMetadataService metadataService`

Create the service under test manually in a `@BeforeEach` method (constructor injection).

Helper methods:
- `createFieldMetadata(String name, FieldMappingType type, String relatedProjEntityId)` - builds FieldMetadata records for test data
- `createEntityMetadata(String tableId, List<FieldMetadata> fields)` - builds EntityMetadata records

Test cases (8-10 tests):

1. **translateExternalIds_translatesIdField** - DTO has "id" = "EXT-123", mock `convertExternalToInternalId("TABLE-1", "EXT-123")` returns "INT-456". Assert `dto.get("id")` equals "INT-456".

2. **translateExternalIds_skipsNullIdField** - DTO has no "id" key. Verify `convertExternalToInternalId` is NOT called for the id translation.

3. **translateExternalIds_translatesEntityMappingStringReference** - DTO has field "organization" = "EXT-ORG-1", field metadata has ENTITY_MAPPING type with relatedProjectionEntityId pointing to an entity with tableId "TABLE-ORG". Mock the metadata service to return projections that contain the related entity. Mock `convertExternalToInternalId("TABLE-ORG", "EXT-ORG-1")` returns "INT-ORG-1". Assert `dto.get("organization")` equals "INT-ORG-1".

4. **translateExternalIds_translatesEntityMappingMapReference** - DTO has field "organization" = Map("id" -> "EXT-ORG-1", "name" -> "Org"). Same setup as above but for Map values. Assert the Map's "id" is updated to "INT-ORG-1".

5. **translateExternalIds_skipsDirectMappingFields** - DTO has a DIRECT_MAPPING field. Verify `convertExternalToInternalId` is NOT called for it.

6. **translateExternalIds_skipsFieldNotInDto** - ENTITY_MAPPING field exists in metadata but DTO does not contain that field name. Verify no translation attempted.

7. **translateExternalIds_handlesConvertReturningOriginalValue** - When `convertExternalToInternalId` returns the same value (external ID not found), DTO value remains the original.

8. **translateExternalIds_handlesMultipleEntityMappingFields** - DTO has two ENTITY_MAPPING fields. Both are translated independently.

**DynamicEndpointRegistryTest:**

Use `@ExtendWith(MockitoExtension.class)` with AAA pattern.

Mock dependencies:
- `@Mock DynamicMetadataService metadataService`

Create registry in `@BeforeEach`.

Test cases (6-8 tests):

1. **resolveEntityByExternalName_findsEntityByExternalName** - Projection has entity with externalName="Product". Call resolveEntityByExternalName("proj", "Product"). Assert returns the entity.

2. **resolveEntityByExternalName_fallsBackToNameWhenExternalNameNull** - Entity has externalName=null, name="Product". Call resolveEntityByExternalName("proj", "Product"). Assert returns the entity.

3. **resolveEntityByExternalName_returnsEmptyForNonExistent** - No entity matches. Assert returns Optional.empty().

4. **resolveEntityByExternalName_returnsEmptyForNonExistentProjection** - Projection not found. Assert returns Optional.empty().

5. **isRestEndpoint_returnsTrueForRestEndpoint** - Entity has restEndPoint=true. Assert returns true.

6. **isRestEndpoint_returnsFalseForNonRestEndpoint** - Entity has restEndPoint=false. Assert returns false.

7. **isRestEndpoint_returnsFalseForNonExistentEntity** - Entity not found. Assert returns false.

8. **logDynamicEndpoints_logsWithoutError** - Set up projections with entities, call logDynamicEndpoints(). Verify no exceptions thrown (the logging itself is not asserted, just that the method runs without error).
  </action>
  <verify>
Both test files exist. ExternalIdTranslationServiceTest has 8+ test methods. DynamicEndpointRegistryTest has 6+ test methods. Both use @ExtendWith(MockitoExtension.class) and AAA pattern.
  </verify>
  <done>
ExternalIdTranslationServiceTest covers: id translation, null id skip, String reference translation, Map reference translation, skip non-EM fields, field not in DTO, original value passthrough, multiple EM fields.
DynamicEndpointRegistryTest covers: resolve by externalName, fallback to name, non-existent entity/projection, restEndPoint true/false, startup logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DynamicRestControllerTest</name>
  <files>modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/DynamicRestControllerTest.java</files>
  <action>
Use `@ExtendWith(MockitoExtension.class)` with AAA pattern. Use LENIENT strictness (same as DynamicRepositoryTest) since some mock setups are shared across tests.

Mock dependencies:
- `@Mock DynamicRepository repository`
- `@Mock DynamicEndpointRegistry endpointRegistry`
- `@Mock ExternalIdTranslationService externalIdTranslationService`

Create controller in `@BeforeEach` via constructor injection.

Shared test fixtures:
- `PROJECTION_NAME = "obmap"` (lowercase, as it comes from URL)
- `ENTITY_NAME = "Product"` (externalName, as it comes from URL)
- `ENTITY_META_NAME = "ProductEntity"` (internal entity name used with repository)
- Create a test `EntityMetadata` with restEndPoint=true, externalName="Product", name="ProductEntity"
- Standard setup: `when(endpointRegistry.resolveEntityByExternalName("obmap", "Product")).thenReturn(Optional.of(testEntityMeta))`

Test cases (12-15 tests):

**GET list tests:**

1. **findAll_returnsPageOfEntities** - Mock `repository.findAll("OBMAP", "ProductEntity", emptyMap, pageable)` returns a `PageImpl` with 2 entities. Call `controller.findAll("obmap", "Product", pageable, emptyMap)`. Assert page has 2 elements.

2. **findAll_removesPageParamsFromFilters** - Call with allParams containing "page", "size", "sort" plus a custom filter "name=test". Verify repository.findAll is called with filters containing only "name=test" (page/size/sort removed).

3. **findAll_returns404ForNonExistentProjection** - Mock resolveEntityByExternalName returns Optional.empty(). Assert `ResponseStatusException` with 404.

**GET by ID tests:**

4. **findById_returnsEntity** - Mock `repository.findById("123", "OBMAP", "ProductEntity")` returns a map. Call findById. Assert ResponseEntity status 200 and body is the map.

5. **findById_returns404WhenNotFound** - Mock repository.findById throws `EntityNotFoundException`. Assert ResponseStatusException with 404.

6. **findById_returns404ForRestEndpointFalse** - Create entity metadata with restEndPoint=false. Mock resolveEntityByExternalName returns this entity. Assert ResponseStatusException with 404 (from resolveEntityMetadata helper).

**POST tests:**

7. **create_singleEntity_returns201** - Call create with JSON string `{"name":"Test"}`. Mock repository.save returns a map. Assert ResponseEntity status 201.

8. **create_callsTranslateExternalIds** - Call create with JSON. Verify `externalIdTranslationService.translateExternalIds` is called with the parsed map and entityMeta.

9. **create_batchEntities_returns201** - Call create with JSON array string `[{"name":"A"},{"name":"B"}]`. Mock repository.saveBatch returns list of 2 maps. Assert ResponseEntity status 201 and body is a list.

10. **create_withJsonPath_extractsNestedData** - Call create with JSON `{"data":{"name":"Test"}}` and json_path `"$.data"`. Mock repository.save returns a map. Verify save is called (json_path extracted the nested object).

11. **create_emptyBody_returns400** - Call with empty string body. Assert ResponseStatusException with 400.

12. **create_defaultsJsonPathToDollarSign** - Call with json_path=null. Verify no exception (defaults to "$" and processes whole document).

**PUT tests:**

13. **update_returnsUpdatedEntity_with201** - Mock repository.update returns a map. Call update with id="123" and JSON body. Assert ResponseEntity status 201.

14. **update_setsIdFromPathVariable** - Call update with id="123". Verify that the DTO map passed to repository.update contains "id"="123".

15. **update_callsTranslateExternalIds** - Verify externalIdTranslationService.translateExternalIds is called before repository.update.

IMPORTANT: The controller methods receive raw path variables and delegate to resolveEntityMetadata. Since this is a unit test (not MockMvc), invoke the controller methods directly. The pageable parameter in findAll can be created via `PageRequest.of(0, 20)`.

For POST/PUT tests that parse JSON internally, the @RequestBody is a raw String. The controller uses ObjectMapper and JsonPath internally, so pass valid JSON strings.
  </action>
  <verify>
File exists. Has @ExtendWith(MockitoExtension.class). Has 12+ test methods covering GET list, GET by ID, POST single, POST batch, POST json_path, PUT, 404 cases, 400 cases, external ID translation calls.
  </verify>
  <done>
DynamicRestControllerTest covers:
- GET list: paginated results, filter param cleanup, 404 for missing projection
- GET by ID: success 200, 404 not found, 404 restEndPoint=false
- POST: single 201, batch 201, json_path extraction, empty body 400, default json_path, translateExternalIds called
- PUT: success 201, id from path, translateExternalIds called
  </done>
</task>

</tasks>

<verification>
1. All three test files exist in `modules_core/com.etendorx.das/src/test/java/com/etendorx/das/controller/`
2. All use `@ExtendWith(MockitoExtension.class)` with AAA pattern
3. ExternalIdTranslationServiceTest: 8+ tests covering id translation, EM field translation, skip logic
4. DynamicEndpointRegistryTest: 6+ tests covering resolution, restEndPoint gating, startup logging
5. DynamicRestControllerTest: 12+ tests covering all CRUD endpoints, error cases, external ID translation
6. Total tests: ~26-30 across all three files
7. No test depends on generated entities (avoids compilation blocker)
</verification>

<success_criteria>
- All test files created with proper structure and meaningful test cases
- Tests cover happy paths and error paths for all three components
- Tests verify external ID translation is called before repository operations
- Tests verify restEndPoint gating (404 for disabled entities)
- Tests verify response status codes match BindedRestController (200 for GET, 201 for POST/PUT)
- Tests use mocks only (no dependency on running database or generated entities)
</success_criteria>

<output>
After completion, create `.planning/phases/04-generic-rest-controller/04-03-SUMMARY.md`
</output>
